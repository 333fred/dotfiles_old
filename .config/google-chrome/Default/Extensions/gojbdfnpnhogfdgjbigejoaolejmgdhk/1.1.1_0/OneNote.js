var ClipperPrefix="ON",ClipperRootUrl="https://www.onenote.com/Clipper/Root?NoAuth=1",ClipperIdPropertyName="clipperId",ClipperExecuteCode="",ClipperId="",ChromeStorage=chrome.storage.local;function GetOrCreateClipperId(a){if(a&&a[ClipperIdPropertyName])ClipperId=a[ClipperIdPropertyName];else{ClipperId=GenerateClipperId();ChromeStorage.set({clipperId:ClipperId});chrome.tabs.getSelected(null,function(a){!IsOnOneNoteDomain(a.url)&&chrome.tabs.create({url:"https://www.onenote.com/Clipper/OneNote"})})}RegisterBrowserAction()}function IsOnOneNoteDomain(a){return a.indexOf("onenote.com")>=0||a.indexOf("onenote-int.com")>=0}function RegisterBrowserAction(){ClipperExecuteCode=GetClipperExecuteCode(null);chrome.browserAction.onClicked.addListener(function(){chrome.tabs.executeScript(null,{code:ClipperExecuteCode})})}function GetClipperExecuteCode(a){return"javascript:(function(){if(document.getElementById('oneNoteCaptureRootScript') == null){var jsCode=document.createElement('script');jsCode.setAttribute('src', '"+ClipperRootUrl+(a?"&"+a:"")+"');jsCode.setAttribute('id','oneNoteCaptureRootScript');jsCode.setAttribute('clipperId','"+ClipperId+"');jsCode.setAttribute('type', 'text/javascript');document.body.appendChild(jsCode);}})()"}function GenerateClipperId(){return ClipperPrefix+"-"+GenerateGuid()}function GenerateGuid(){return GenerateFourCharGuid()+GenerateFourCharGuid()+"-"+GenerateFourCharGuid()+"-"+GenerateFourCharGuid()+"-"+GenerateFourCharGuid()+"-"+GenerateFourCharGuid()+GenerateFourCharGuid()+GenerateFourCharGuid()}function GenerateFourCharGuid(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}ChromeStorage.get(ClipperIdPropertyName,GetOrCreateClipperId);chrome.runtime.onMessage.addListener(function(a,c,b){console.log(c.tab?"from a content script:"+c.tab.url:"from the extension");console.log("Request action:"+a.action);if(a.action=="tt_process"){tt_process(b);return true}else if(a.action=="clip")chrome.tabs.executeScript(null,{code:GetClipperExecuteCode("tooltip=1")},function(){b({clip:true});return false});else{console.log("bad request");return false}});var ClipperTooltipDisplayTimeProperty="tooltiplastdisplaytime",ClipperTooltipLastUpdateTimeKey="lastTooltipManagerUpdate",ClipperTooltipManagerKey="tooltipmanagercode",ClipperTooltipManagerUpdateInterval=12*60*60*1e3,ClipperTooltipEnabled=true;function RunTooltipScript(a){if(!ClipperTooltipEnabled){a();return}ChromeStorage.get(ClipperTooltipLastUpdateTimeKey,function(b){if(!(b&&b[ClipperTooltipLastUpdateTimeKey])||Date.now()-b[ClipperTooltipLastUpdateTimeKey]>ClipperTooltipManagerUpdateInterval){console.log("Getting a fresh copy of TooltipManager");$.ajax({url:"https://www.onenote.com/Clipper/TooltipManager?noauth=1&clipperId="+ClipperId,cache:false,success:function(b){if(!b){console.log("no code was found");a()}else chrome.tabs.executeScript(null,{code:b},function(b){console.log("result from execution is "+b);(!b||b=="{}")&&a();a($.extend({tt_process:true},JSON.parse(b)))});CacheTooltipScript(b)},dataType:"text",error:function(){CacheTooltipScript("");a()}})}else ChromeStorage.get(ClipperTooltipManagerKey,function(b){if(!(b&&b[ClipperTooltipManagerKey])){a();return}chrome.tabs.executeScript(null,{code:b[ClipperTooltipManagerKey]},function(b){console.log("result from execution is "+b);(!b||b=="{}")&&a();a($.extend({tt_process:true},JSON.parse(b)))})})})}function CacheTooltipScript(b){var a={};a[ClipperTooltipLastUpdateTimeKey]=Date.now();a[ClipperTooltipManagerKey]=b;ChromeStorage.set(a,function(){if(chrome.runtime.lastError)ClipperTooltipEnabled=false})}function CheckpointTooltipDisplay(c){var b=Date.now(),a={};a[ClipperTooltipDisplayTimeProperty]=b;a[ClipperTooltipDisplayTimeProperty+"_"+c]=b;ChromeStorage.set(a,function(){if(chrome.runtime.lastError)ClipperTooltipEnabled=false})}function ValidateTooltipDisplayAgainstGlobalTimer(b,a){var c=b.tooltipTimer,d=b.tooltipTypeTimer;if(typeof c=="undefined"||typeof d=="undefined"){console.log("tooltipTimer and tooltipTypeTimer are not set. Disabling tooltip display.");a(false);return}console.log("Verifying the tooltip timer values against the previous tooltip display time");ChromeStorage.get(ClipperTooltipDisplayTimeProperty,function(h){var g=Date.now();console.log("Current timestamp: "+g);if(h&&h[ClipperTooltipDisplayTimeProperty]){var i=h[ClipperTooltipDisplayTimeProperty],e=g-i;console.log("lastTooltipDisplay time: "+i);console.log("timeDiff : "+e+", tooltipTimer : "+c);if(e>c){var f=ClipperTooltipDisplayTimeProperty+"_"+b.tooltipType;ChromeStorage.get(f,function(b){if(b&&b[f]){var c=+new Date(b[f]);e=g-c;if(e>parseInt(d))a(true);else a(false)}else a(true)})}else a(false)}else{console.log("First tooltip display");a(true)}})}function ProcessTooltipDisplayRequestAndRespond(a,b){ValidateTooltipDisplayAgainstGlobalTimer(a,function(c){console.log("ProcessTooltipDisplayRequestAndRespond: Validation against timers returned "+c);if(c==true){CheckpointTooltipDisplay(a.tooltipType);b(a)}else b({tt_process:false})})}function tt_process(a){RunTooltipScript(function(b){if(b&&b.tt_process==true)ProcessTooltipDisplayRequestAndRespond(b,a);else a({tt_process:false})})};